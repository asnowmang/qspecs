#! /bin/sh
## Version 0.1.3
## Currently supports OpenBSD and OS X


# OS Detection
OS=$(uname -s)


# Manufacturer
case $OS in
    Darwin)
	man="Apple, Inc."
	;;
    OpenBSD)
	man=$(sysctl -n hw.vendor)
	;;
    Linux)
	man=$(lspci -v | awk 'NR==2 {print $2}')
	;;
esac


# Device model
case $OS in
    Darwin)
	model=$(sysctl -n hw.model)
	;;
    OpenBSD)
	model=$(sysctl -n hw.product)
	;;
    Linux)
#	model=$(cat /proc/cpuinfo | sed 's/.*: //' | sed -n 2p)
	model=$(lspci -v | awk 'NR==2 {print $4, $5, $6}' | sed 's/N36L/Gen 7/')
	;;
esac


# CPU model and clock
case $OS in
    Darwin)
	CPU=$(sysctl -n machdep.cpu.brand_string | sed 's/@.*//')
	clock="@ $(dc -e $(sysctl -n hw.cpufrequency)d1000d*/n[MHz]p)"
	;;
    OpenBSD)
	CPU=$(sysctl -n hw.model)
	;;
    Linux)
	CPU=$(cat /proc/cpuinfo | sed -n 's/^[^:]*: //;5p')
	clock="@ 1500MHz"
	;;
esac


# CPU temp
case $OS in
    Darwin)
	tempmon=/Applications/TemperatureMonitor.app/Contents/MacOS/tempmonitor
	CPUtemp=$(echo "$($tempmon -a -l | grep "A DIODE")" | sed 's/.*: //g;s/C/°C/;s/ //')
	;;
    OpenBSD)
	CPUtemp=$(sysctl -n hw.sensors.cpu0.temp0 | sed 's/'.00'//')
	;;
    Linux)
	CPUtemp=$(sensors | awk '{ print $2 }' | sed -n 's/+//;7p')
	;;
esac


# GPU
case $OS in
    Darwin)
	gpu=$(system_profiler SPDisplaysDataType | sed -n 's/^[ \t]*//;s/://;s/ATI/ATi/;3p')
	;;
    OpenBSD)
	;;
    Linux)
	gpu=$(lshw -C display 2>/dev/null | sed -n 's/.*\[\([^]]*\)\].*/\1/g;3p')
	;;
esac


# GPU temp
case $OS in
    Darwin)
	GPUtemp=$(tempmon -a | sed -n 's/ /°/;7p')
	;;
    OpenBSD)
	;;
    Linux)
	GPUtemp=$(sensors | awk '{ print $2 }' | sed -n 's/+//;3p')
	;;
esac


# RAM
case $OS in
    Darwin)
	RAM=$(sysctl -n hw.memsize)
	;;
    OpenBSD)
	RAM=$(sysctl -n hw.physmem)
	;;
    Linux)
	RAM=$(dc -e $(free | awk '{ print $2 }' | sed -n 2p)d1024*p)
	;;
esac


# Storage
count="1"
sto="0"
p=$(df -k -l | wc -l | sed 's/ //g')
until [ $count = $p ];
do
    count=$(dc -e "$count"d1+p)
    part=$(df -k -l | awk '{ print $2 }' | sed -n "$count"p)
    sto=$(dc -e "$sto"d"$part"+p)
done
t=$(echo $sto | wc -c | sed 's/ //g')
case $t in
    6 | 7)
        sto=$(dc -e "$sto"d1024/n[MiB]p)
        ;;
    8 | 9 | 10)
        sto=$(dc -e "$sto"d1024d*/n[GiB]p)
        ;;
    11 | 12 | 13) 
	sto=$(dc -e "$sto"d1024dd**/n[TiB]p)
	;;
esac


# OS
case $OS in
    Darwin)
	OSV="$(sw_vers -productName) $(sw_vers -productVersion) $(uname -p | sed 's/i386/x86_64/;s/powerpc/PowerPC/')"
	;;
    OpenBSD)
	OSV=$(uname -srm)
	;;
    Linux)
	OSV="Debian $(cat /etc/*_version)"
	;;
esac


# Kernel
case $OS in
    Darwin)
	kern="XNU$(uname -v | sed 's#.*;##;s#/.*##;s#root:xnu-##')"
	;;
    OpenBSD)
	kern=$(uname -sr)
	;;
    Linux)
	kern=$(uname -sr)
	;;
esac


# Packages
case $OS in
    Darwin)
	pkg=$(dc -e $(pkgin list | wc -l)d$(brew list | wc -l | sed 's/ //g')+p)
	;;
    OpenBSD)
	pkg=$(pkg_info | wc -l | sed 's/[^0-9]*//')
	;;
    Linux)
	pkg=$(dpkg -l | wc -l)
	;;
esac


# Uptime
up=$(uptime | sed ';s/,.*//;s/^.*up //;')


# Shell
s="$(basename $SHELL)"


########
# Output
# Temp colors
RED='\033[0;31m'
NC='\033[0m' # No Color

# Manufacturer
echo "\n Manufacturer:\t $man"

# Model
echo " Model:\t\t $model"

# CPU model, clock, and temp
echo " CPU:\t\t $(echo $CPU | sed 's/CPU //;s/(TM)//;s/ Dual-Core Processor//;s/(tm)//;s/(R)//;s/ APU with Radeon HD Graphics//') $clock ${RED}$CPUtemp${NC}"

# GPU model and temp
echo " GPU:\t\t $gpu ${RED}$GPUtemp${NC}"

# RAM
echo " RAM:\t\t $(dc -e "$RAM"d1024d*/n[MiB]p)"

# Storage
echo " Storage:\t $sto"

# OS
echo " OS:\t\t $OSV"

# Kernel
echo " Kernel:\t $kern"

# Packages
echo " Packages:\t $pkg"

# Uptime
echo " Uptime:\t $up"

# Shell
echo " Shell:\t\t $s\n"
